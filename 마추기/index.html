<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆì¶”ê¸° - í€´ì¦ˆ í”Œë«í¼</title>
    <style>
        /* [ìŠ¤íƒ€ì¼] ê¸°ë³¸ ì„¤ì • */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif; background-color: #f8f9fa; color: #333; display: flex; flex-direction: column; min-height: 100vh; }
        a { text-decoration: none; color: inherit; cursor: pointer; }
        .hidden { display: none !important; }

        /* í—¤ë” */
        header { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; background-color: white; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 100; }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .logo-box { display: flex; align-items: center; gap: 8px; font-weight: 800; font-size: 20px; color: #4A469F; cursor: pointer; }
        .logo-icon { width: 32px; height: 32px; background-color: #4A469F; border-radius: 8px; color: white; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .search-bar { display: none; background-color: #f1f3f5; padding: 8px 16px; border-radius: 20px; width: 300px; color: #495057; font-size: 14px; align-items: center; gap: 10px; }
        .search-icon { width: 16px; height: 16px; fill: #adb5bd; flex-shrink: 0; }
        .search-input { width: 100%; background: transparent; border: none; outline: none; color: #343a40; font-size: 14px; }
        @media (min-width: 768px) { .search-bar { display: flex; } }
        .header-right { display: flex; gap: 10px; }
        .btn { padding: 8px 14px; border: none; border-radius: 8px; font-size: 13px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn-create { background-color: #4A469F; color: white; }
        .btn-create:hover { background-color: #3b3782; }
        .btn-outline { background-color: white; border: 1px solid #e9ecef; color: #495057; }
        .btn-outline:hover { background-color: #f8f9fa; border-color: #dee2e6; }

        /* ì»¨í…Œì´ë„ˆ */
        .container { max-width: 1200px; margin: 0 auto; padding: 30px 20px; flex: 1; width: 100%; }
        .tabs { display: flex; gap: 20px; margin-bottom: 24px; overflow-x: auto; padding-bottom: 10px; }
        .tab { font-weight: 700; color: #868e96; cursor: pointer; white-space: nowrap; padding-bottom: 4px; }
        .tab.active { color: #212529; border-bottom: 2px solid #212529; }

        /* [ìˆ˜ì •ë¨] ê·¸ë¦¬ë“œ ì¹´ë“œ & ì¸ë„¤ì¼ ìŠ¤íƒ€ì¼ */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 24px; }
        .card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.04); cursor: pointer; display: flex; flex-direction: column; transition: transform 0.2s; border: 1px solid #f1f3f5; }
        .card:hover { transform: translateY(-6px); box-shadow: 0 12px 24px rgba(0,0,0,0.08); }
        
        .thumb { 
            width: 100%; 
            height: 160px; 
            position: relative; 
            background-color: #e9ecef; /* ì´ë¯¸ì§€ê°€ ì—†ì„ ë•Œ ê¸°ë³¸ ë°°ê²½ìƒ‰ */
            overflow: hidden; 
        }
        
        /* ì¸ë„¤ì¼ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ê½‰ ì°¨ê²Œ í‘œì‹œ */
        .thumb img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; /* ë¹„ìœ¨ ìœ ì§€í•˜ë©° ê½‰ ì±„ìš°ê¸° */
            position: absolute; 
            top: 0; 
            left: 0;
            transition: transform 0.3s;
        }
        
        .card:hover .thumb img { transform: scale(1.05); } /* í˜¸ë²„ ì‹œ ì´ë¯¸ì§€ ì‚´ì§ í™•ëŒ€ */

        .bg-worldcup { background: linear-gradient(45deg, #FF416C, #FF4B2B); }
        .bg-machugi { background: linear-gradient(45deg, #8E2DE2, #4A00E0); }
        .bg-balance { background: linear-gradient(45deg, #00b09b, #96c93d); }
        .bg-normal { background: linear-gradient(45deg, #F7971E, #FFD200); }
        
        .play-icon { 
            position: absolute; 
            bottom: 12px; 
            right: 12px; 
            background-color: rgba(46, 204, 113, 0.9); 
            width: 36px; 
            height: 36px; 
            border-radius: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 2; 
            backdrop-filter: blur(4px);
        }
        .play-icon svg { width: 18px; height: 18px; fill: white; margin-left: 2px; }
        
        .info { padding: 18px; display: flex; flex-direction: column; flex-grow: 1; position: relative; z-index: 1; background: white; }
        .card-title { font-size: 16px; font-weight: 700; margin-bottom: 8px; color: #212529; }
        .card-desc { font-size: 13px; color: #868e96; line-height: 1.5; margin-bottom: 12px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .card-footer { display: flex; align-items: center; gap: 8px; font-size: 12px; color: #adb5bd; border-top: 1px solid #f8f9fa; padding-top: 12px; }
        .user-avatar { width: 20px; height: 20px; background-color: #dee2e6; border-radius: 50%; }

        /* í¼ ìŠ¤íƒ€ì¼ */
        .form-container { max-width: 600px; margin: 0 auto; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid #f1f3f5; }
        .page-title { font-size: 24px; font-weight: 800; margin-bottom: 30px; text-align: center; }
        .form-group { margin-bottom: 24px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 700; font-size: 14px; color: #495057; }
        .form-input, .form-select { width: 100%; padding: 14px; border: 1px solid #e9ecef; border-radius: 12px; font-size: 15px; background-color: #f8f9fa; }
        .submit-btn { width: 100%; padding: 16px; background-color: #4A469F; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 10px; }
        .input-group { display: flex; gap: 10px; } .input-group .form-input { flex: 1; }
        .btn-check { padding: 14px; background-color: #6c757d; color: white; border: none; border-radius: 12px; font-size: 14px; font-weight: 700; cursor: pointer; white-space: nowrap; }

        /* ê°œìˆ˜ ì„ íƒ */
        .quiz-select-container { max-width: 600px; margin: 0 auto; padding: 60px 20px; text-align: center; }
        .quiz-select-title { font-size: 24px; font-weight: 800; margin-bottom: 40px; color: #000; }
        .count-options { display: flex; flex-direction: column; gap: 12px; max-width: 400px; margin: 0 auto; }
        .count-btn { padding: 16px; border-radius: 8px; background: #F3F3F3; color: #333; border: none; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s; width: 100%; }
        .count-btn:hover { background: #e0e0e0; }
        .count-btn.selected { background: #6A5AE0; color: white; box-shadow: 0 4px 10px rgba(106, 90, 224, 0.3); }
        .action-buttons { display: flex; flex-direction: column; align-items: center; gap: 10px; margin-top: 24px; }
        .start-btn { width: 100%; max-width: 400px; padding: 16px; border: none; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; background: #6A5AE0; color: white; box-shadow: 0 4px 10px rgba(106, 90, 224, 0.3); }
        .start-btn:hover { background: #5848c2; }
        .start-btn.disabled { background: #b5b5b5; cursor: not-allowed; box-shadow: none; }
        .back-btn { background: none; border: none; color: #888; cursor: pointer; font-size: 14px; font-weight: 600; padding: 10px; }
        .back-btn:hover { color: #555; text-decoration: underline; }

        /* í”Œë ˆì´ í™”ë©´ ê³µí†µ */
        .play-container { max-width: 1200px; margin: 0 auto; height: 100%; text-align: center; display: flex; flex-direction: column; }
        .play-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; font-weight: bold; font-size: 1.2rem; }
        .quiz-question { font-size: 26px; font-weight: 800; margin-bottom: 30px; word-break: keep-all; }
        
        /* ë§ˆì¶”ê¸° í€´ì¦ˆ ì´ë¯¸ì§€ */
        .quiz-image { 
            width: auto; max-width: 100%; height: auto; max-height: 500px;
            object-fit: contain; border-radius: 16px; 
            margin: 0 auto 24px; background: #fff; 
            display: block; box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
        }
        
        /* ì›”ë“œì»µ ë ˆì´ì•„ì›ƒ */
        .wc-container { display: flex; gap: 20px; height: 500px; align-items: center; justify-content: center; width: 100%; }
        .wc-item { 
            flex: 1; height: 100%; position: relative; border-radius: 20px; overflow: hidden; 
            cursor: pointer; border: 1px solid #eee; transition: 0.2s; background: #fff;
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
        }
        .wc-item:hover { border-color: #4A469F; transform: scale(1.02); z-index: 5; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .wc-item img { width: 100%; height: 100%; object-fit: contain; padding: 10px; }
        .wc-text { position: absolute; bottom: 0; left: 0; width: 100%; padding: 20px; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); color: white; text-align: center; font-weight: 800; font-size: 1.5rem; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .wc-vs { font-size: 50px; font-weight: 900; color: #4A469F; margin: 0 10px; font-style: italic; text-shadow: 2px 2px 0px #fff; }

        /* ë°¸ëŸ°ìŠ¤ ê²Œì„ */
        .vs-container { display: flex; gap: 15px; margin-top: 10px; }
        .vs-item { flex: 1; cursor: pointer; position: relative; border-radius: 16px; height: 300px; border: 1px solid #eee; background: #f8f9fa; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 15px; font-size: 22px; font-weight: bold; transition: 0.2s; word-break: keep-all; }
        .vs-item:hover { transform: scale(1.02); z-index: 10; box-shadow: 0 10px 20px rgba(0,0,0,0.1); border-color: #4A469F; background-color: #fff; }
        
        /* ë§ˆì¶”ê¸° ì¸í’‹ */
        .machugi-input-container { margin-top: 0px; display: flex; gap: 10px; justify-content: center; width: 100%; max-width: 500px; margin-left: auto; margin-right: auto; }
        .machugi-input { padding: 14px; border: 2px solid #ddd; border-radius: 12px; font-size: 18px; flex: 1; text-align: center; transition: 0.2s; }
        .machugi-input:focus { border-color: #4A469F; outline: none; box-shadow: 0 0 0 3px rgba(74, 70, 159, 0.1); }
        .machugi-btn { padding: 14px 24px; background-color: #4A469F; color: white; border: none; border-radius: 12px; font-weight: 800; font-size: 16px; cursor: pointer; transition: 0.2s; }
        .machugi-btn:hover { background-color: #3b3782; }

        /* ê²°ê³¼/í†µê³„ í˜ì´ì§€ */
        .panel { background:#fff; border:1px solid #f1f3f5; border-radius:24px; box-shadow:0 4px 20px rgba(0,0,0,0.05); padding:28px; max-width: 960px; margin: 0 auto; }
        .stats-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:16px; margin-top: 20px; }
        .stat-card { background:#fff; border:1px solid #f1f3f5; border-radius:16px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,0.04); text-align: left; }
        .stat-title { font-weight:800; color:#495057; font-size:13px; margin-bottom:6px; }
        .stat-value { font-size:28px; font-weight:900; color:#212529; }
        .progress { height:12px; background:#f1f3f5; border-radius:999px; overflow:hidden; margin-top: 10px; }
        .progress-bar { height:12px; background: linear-gradient(90deg,#8E2DE2,#4A00E0); }
        .grade-badge { display:inline-flex; align-items:center; justify-content:center; min-width:56px; height:32px; padding:0 12px; border-radius:999px; font-weight:900; color:#fff; }
        .grade-S{ background:#6f42c1;} .grade-A{background:#2fb344;} .grade-B{background:#15aabf;} .grade-C{background:#fab005;} .grade-D{background:#fa5252;} .grade-F{background:#212529;}
        
        .recent { margin-top:22px; text-align: left; }
        .recent-head, .recent-row { display:grid; grid-template-columns:120px 1fr 110px 90px; gap:10px; padding:12px; align-items:center; font-size:13px; }
        .recent-head { font-weight:800; color:#495057; background:#f8f9fa; border-top-left-radius:12px; border-top-right-radius:12px; border:1px solid #f1f3f5; border-bottom:none; }
        .recent-row { border:1px solid #f1f3f5; border-top:none; background:#fff; }
        .recent-actions { margin-top:12px; text-align:right; }
        .subtitle { color:#868e96; font-size:12px; }

        .simple-result-container { text-align: center; }
        .simple-result-score { font-size: 36px; font-weight: 900; color: #4A469F; margin: 10px 0 20px; }
        .simple-result-desc { font-size: 18px; color: #495057; margin-bottom: 30px; line-height: 1.6; }
        .simple-result-image { width: 100%; max-width: 400px; height: auto; object-fit: contain; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }

        footer { margin-top: 60px; padding: 40px 20px; text-align: center; background-color: #eee; color: #999; font-size: 13px; }
        
        /* í€´ì¦ˆ ë§Œë“¤ê¸° (ìˆ¨ê¹€) */
        .qc-title { font-size: 24px; font-weight: 700; margin-bottom: 6px; }
        .qc-card { background: white; border-radius: 16px; box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08); padding: 24px; }
        .qc-top-grid { display: grid; grid-template-columns: minmax(0, 320px) minmax(0, 1fr); gap: 24px; margin-bottom: 24px; }
        .qc-main-upload { border-radius: 16px; border: 1px dashed #c7cce0; background: #f7f7ff; height: 200px; display: flex; align-items: center; justify-content: center; flex-direction: column; text-align: center; }
        .qc-textarea { width: 100%; border-radius: 10px; border: 1px solid #d4d8ea; padding: 10px 12px; min-height: 68px; background: #f9fafc; }
        .qc-question-card { display: grid; grid-template-columns: 140px minmax(0, 1fr) auto; gap: 16px; align-items: flex-start; border-radius: 14px; border: 1px solid #e1e4f2; padding: 14px; margin-bottom: 10px; background: #fdfdff; }
        .qc-question-upload { border-radius: 12px; border: 1px dashed #c7cce0; background: #f7f7ff; height: 120px; display: flex; align-items: center; justify-content: center; flex-direction: column; font-size: 12px; }
        .qc-btn-add { width: 100%; padding: 10px; border-radius: 999px; border: 1px dashed #b5bce0; background: #f7f8ff; color: #6a5ae0; cursor: pointer; }
        .qc-bottom-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 12px; }
    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <div class="logo-box" onclick="showPage('home')"><div class="logo-icon">M</div>Machugi</div>
            <div class="search-bar">
                <svg class="search-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 10-.71.71l.27.28v.79l5 4.99L20.49 19l-5-5zm-5 0a4.5 4.5 0 110-9 4.5 4.5 0 010 9z"></path></svg>
                <input id="search-input" class="search-input" type="search" placeholder="í€´ì¦ˆ ê²€ìƒ‰">
            </div>
        </div>
        <div class="header-right">
            <div id="auth-guest" class="header-right">
                <button class="btn btn-outline" onclick="goToLogin(false)">ë¡œê·¸ì¸</button>
                <button class="btn btn-create" onclick="goToLogin(true)">íšŒì›ê°€ì…</button>
            </div>
            <div id="auth-user" class="header-right hidden">
                <button class="btn btn-create" onclick="showPage('create')">+ ë§Œë“¤ê¸°</button>
                <button class="btn btn-outline" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </header>

    <div id="home-page" class="container">
        <div class="tabs">
            <div class="tab active" onclick="filterCategory('all', this)">ì „ì²´</div>
            <div class="tab" onclick="filterCategory('worldcup', this)">ì›”ë“œì»µ</div>
            <div class="tab" onclick="filterCategory('machugi', this)">ë§ˆì¶”ê¸°</div>
            <div class="tab" onclick="filterCategory('balance', this)">ë°¸ëŸ°ìŠ¤ ê²Œì„</div>
        </div>
        <div class="grid" id="quiz-grid"></div>
        <div id="empty-state" class="hidden" style="text-align:center; padding:20px; color:#888;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
    </div>

    <div id="select-count-page" class="container hidden">
        <div class="quiz-select-container">
            <h2 class="quiz-select-title">ë¬¸ì œ ê°œìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</h2>
            <div id="count-options" class="count-options"></div>
            <div class="action-buttons">
                <button id="startBtn" class="start-btn disabled" onclick="startRealQuiz()">ì‹œì‘í•˜ê¸°</button>
                <button class="back-btn" onclick="showPage('home')">â† ëŒì•„ê°€ê¸°</button>
            </div>
        </div>
    </div>

    <div id="login-page" class="container hidden">
        <div class="form-container" style="max-width: 400px;">
            <h2 class="page-title" id="auth-title" style="color:#4A469F;">ë¡œê·¸ì¸</h2>
            <div id="auth-section">
                <div class="form-group">
                    <label class="form-label">ì•„ì´ë””</label>
                    <div class="input-group">
                        <input type="text" id="auth-username" class="form-input" placeholder="ì•„ì´ë””" onkeydown="if(event.key === 'Enter') handleAuth()">
                        <button type="button" id="btn-check-id" class="btn-check hidden" onclick="checkId()">ì¤‘ë³µí™•ì¸</button>
                    </div>
                </div>
                <div class="form-group hidden" id="email-group"><label class="form-label">ì´ë©”ì¼</label><input type="email" id="auth-email" class="form-input" placeholder="example@gmail.com" onkeydown="if(event.key === 'Enter') handleAuth()"></div>
                <div class="form-group hidden" id="nickname-group"><label class="form-label">ë‹‰ë„¤ì„</label><input type="text" id="auth-nickname" class="form-input" placeholder="ë‹‰ë„¤ì„" onkeydown="if(event.key === 'Enter') handleAuth()"></div>
                <div class="form-group"><label class="form-label">ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="auth-password" class="form-input" placeholder="ë¹„ë°€ë²ˆí˜¸" onkeydown="if(event.key === 'Enter') handleAuth()"></div>
                <div class="form-group hidden" id="password-confirm-group"><label class="form-label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label><input type="password" id="auth-password-confirm" class="form-input" placeholder="ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥" onkeydown="if(event.key === 'Enter') handleAuth()"></div>
                <button class="submit-btn" id="auth-btn" onclick="handleAuth()">ë¡œê·¸ì¸ í•˜ê¸°</button>
                <p style="margin-top: 20px; text-align: center; color: #666; font-size: 14px;"><span onclick="toggleFindMode()" style="color: #4A469F; font-weight: 800; cursor: pointer; text-decoration: underline;">ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</span></p>
            </div>
            <div id="find-section" class="hidden">
                <p style="margin-bottom: 20px; font-size: 14px; color: #666; text-align:center;">ê°€ì… ì‹œ ë“±ë¡í•œ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
                <div class="form-group"><label class="form-label">ì´ë©”ì¼</label><input type="email" id="find-email" class="form-input" placeholder="example@gmail.com" onkeydown="if(event.key === 'Enter') handleFindAccount()"></div>
                <button class="submit-btn" onclick="handleFindAccount()">ì •ë³´ ì°¾ê¸°</button>
                <button class="btn btn-outline" style="width:100%; margin-top:10px;" onclick="toggleFindMode()">ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
            </div>
        </div>
    </div>

    <div id="create-page" class="container hidden">
        <section class="quiz-create-page">
            <h1 class="qc-title">í€´ì¦ˆ ë§Œë“¤ê¸°</h1>
            <div class="qc-card">
                <div class="qc-top-grid">
                    <div class="qc-main-upload"><span class="icon">ğŸ“·</span><label class="btn-main-upload" for="mainImage">ì„ íƒ</label><input type="file" id="mainImage" accept="image/*" /></div>
                    <div>
                        <div class="form-group"><label class="qc-label">ì œëª©</label><input type="text" class="form-input" placeholder="ì œëª©"></div>
                        <div class="form-group"><label class="qc-label">ì„¤ëª…</label><textarea class="qc-textarea" placeholder="ì„¤ëª…"></textarea></div>
                    </div>
                </div>
                <div class="qc-input-group"><span class="qc-label">í€´ì¦ˆ ëª©ë¡</span></div>
                <div id="questionList" class="qc-question-list"></div>
                <button type="button" class="qc-btn-add" onclick="addQuestionCard()">+ í€´ì¦ˆ ì¶”ê°€í•˜ê¸°</button>
                <div class="qc-bottom-actions"><button type="button" class="submit-btn" onclick="alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!'); showPage('home');">ë°œí–‰í•˜ê¸°</button></div>
            </div>
        </section>
    </div>

    <div id="play-page" class="container hidden">
        <div class="play-container">
            <div class="play-header"><span id="round-info"></span><button class="btn" style="font-size:20px; padding:5px;" onclick="if(confirm('ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) showPage('home')">âœ•</button></div>
            <div id="quiz-content" style="flex:1; display:flex; flex-direction:column; justify-content:center;"></div>
        </div>
    </div>

    <div id="result-page" class="container hidden">
        <div id="result-content-wrapper"></div>
    </div>

    <footer><p>Machugi Â© 2024. All rights reserved.</p></footer>

    <script>
        const API_URL = "http://localhost:3000"; // ì„œë²„ ì£¼ì†Œ
        let allQuizzes = [];
        let currentQuiz = {};
        
        let wcState = { round: [], nextRound: [], roundName: 16 };
        let normalState = { questions: [], index: 0, scoreA: 0, scoreB: 0, score: 0 };
        
        let selectedCount = 0;
        let isSignupMode = false;

        // --- í†µê³„ ê´€ë ¨ í•¨ìˆ˜ ---
        const STORAGE_KEY = 'machugi_stats_v1';
        function loadStats(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch(e){ return []; } }
        function saveStats(entry){ const list = loadStats(); list.push(entry); localStorage.setItem(STORAGE_KEY, JSON.stringify(list.slice(-200))); }
        function clearStats(){ localStorage.removeItem(STORAGE_KEY); renderStats(); }
        function percent(correct,total){ if(!total) return 0; return Math.round((correct/total)*100); }
        function gradeByPercent(p){ if(p>=90) return 'S'; if(p>=80) return 'A'; if(p>=70) return 'B'; if(p>=60) return 'C'; if(p>=40) return 'D'; return 'F'; }
        function gradeText(g){ return { S:'ì™„ë²½ì— ê°€ê¹ìŠµë‹ˆë‹¤!', A:'ë§¤ìš° ìš°ìˆ˜í•´ìš”!', B:'ì¢‹ì€ ì‹¤ë ¥ì´ì—ìš”.', C:'ë³´í†µ ìˆ˜ì¤€ì´ì—ìš”.', D:'ì¡°ê¸ˆë§Œ ë” ì—°ìŠµí•´ìš”.', F:'ì‹œì‘ì´ ë°˜! ë‹¤ì‹œ ë„ì „!' }[g] || ''; }
        function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

        function renderStats(){
            const list = loadStats();
            let total=0, correct=0;
            list.forEach(it => { total += (it.total||0); correct += (it.correct||0); });
            const p = percent(correct,total); const g = gradeByPercent(p);
            
            // í†µê³„ ìš”ì†Œ ì—…ë°ì´íŠ¸
            if(document.getElementById('stat-correct')) {
                document.getElementById('stat-correct').innerText = String(correct);
                document.getElementById('stat-total').innerText = `ì „ì²´ ${total}ë¬¸ì œ`;
                document.getElementById('stat-percent').innerText = String(p);
                document.getElementById('stat-bar').style.width = p + '%';
                const ge = document.getElementById('stat-grade');
                ge.innerText = g; ge.className = 'grade-badge grade-' + g; 
                document.getElementById('stat-grade-text').innerText = gradeText(g);

                const recent = list.slice(-10).reverse();
                const rc = document.getElementById('recent-container');
                rc.innerHTML = recent.map(it => {
                    const d = new Date(it.ts || Date.now()); const pc = percent(it.correct, it.total);
                    return `<div class="recent-row"><div>${d.toLocaleDateString()}<br><span style="color:#adb5bd">${d.toLocaleTimeString()}</span></div><div>${escapeHtml(it.title||'í€´ì¦ˆ')}</div><div>${it.correct}/${it.total}</div><div>${pc}%</div></div>`;
                }).join('') || `<div class="recent-row" style="color:#868e96; display:flex; justify-content:center; grid-template-columns:1fr;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
            }
        }

        // --- ì´ˆê¸°í™” ---
        window.addEventListener('DOMContentLoaded', async () => {
            await checkLogin();
            await fetchQuizzes();
        });

        async function fetchQuizzes() {
            try {
                const res = await fetch(`${API_URL}/api/quizzes`);
                const data = await res.json();
                if(data.success) {
                    allQuizzes = data.quizzes;
                    renderQuizzes(allQuizzes);
                }
            } catch(e) {}
        }

        function renderQuizzes(list) {
            const grid = document.getElementById('quiz-grid');
            grid.innerHTML = '';
            if(list.length === 0) { document.getElementById('empty-state').classList.remove('hidden'); return; }
            document.getElementById('empty-state').classList.add('hidden');

            list.forEach(quiz => {
                const div = document.createElement('div');
                div.className = 'card';
                div.setAttribute('data-category', quiz.category);
                div.onclick = () => prepareQuiz(quiz); 

                let bgClass = 'bg-normal';
                if(quiz.category === 'worldcup') bgClass = 'bg-worldcup';
                else if(quiz.category === 'machugi') bgClass = 'bg-machugi';
                else if(quiz.category === 'balance') bgClass = 'bg-balance';

                // [ìˆ˜ì •] ì¸ë„¤ì¼ ì²˜ë¦¬: ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì´ë¯¸ì§€ë¥¼ ë³´ì—¬ì£¼ê³ , ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´
                // ë§Œì•½ ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ë°°ê²½ìƒ‰(bgClass)ë§Œ ë³´ì´ê²Œ ë¨
                const imgTag = quiz.image_url ? `<img src="${API_URL}${quiz.image_url}" onerror="this.style.display='none'">` : '';

                div.innerHTML = `
                    <div class="thumb ${bgClass}">
                        ${imgTag}
                        <div class="play-icon"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg></div>
                    </div>
                    <div class="info">
                        <div class="card-title">${quiz.title}</div>
                        <div class="card-desc">${quiz.description || ''}</div>
                        <div class="card-footer"><div class="user-avatar"></div><span>ì°¸ì—¬ì ${quiz.play_count || 0}</span></div>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        function prepareQuiz(quiz) {
            currentQuiz = quiz;
            showPage('select-count-page');
            const opts = document.getElementById('count-options');
            opts.innerHTML = '';
            document.getElementById('startBtn').classList.add('disabled');
            selectedCount = 0;

            if(quiz.category === 'worldcup') {
                [8, 16, 32].forEach(cnt => {
                    opts.innerHTML += `<button class="count-btn" onclick="selectCount(this, ${cnt})">${cnt}ê°•</button>`;
                });
            } else {
                [10, 20, 30].forEach(cnt => {
                    opts.innerHTML += `<button class="count-btn" onclick="selectCount(this, ${cnt})">${cnt}ë¬¸ì œ</button>`;
                });
                opts.innerHTML += `<button class="count-btn" onclick="selectCount(this, 'all')">ì „ì²´ ë¬¸ì œ</button>`;
            }
        }

        function selectCount(btn, count) {
            document.querySelectorAll('.count-btn').forEach(b => {
                b.classList.remove('selected');
                b.style.backgroundColor = '#f3f3f3';
                b.style.color = '#333';
            });
            btn.classList.add('selected');
            btn.style.backgroundColor = '#6A5AE0';
            btn.style.color = 'white';
            selectedCount = count;
            document.getElementById('startBtn').classList.remove('disabled');
        }

        async function startRealQuiz() {
            if(!selectedCount) return;
            try {
                const res = await fetch(`${API_URL}/api/quiz/${currentQuiz.id}/questions?count=${selectedCount}`);
                const data = await res.json();
                
                if(data.success && data.questions.length > 0) {
                    if (currentQuiz.category === 'worldcup' && data.questions.length < selectedCount) {
                         alert(`ë¬¸ì œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. (í˜„ì¬ ${data.questions.length}ê°œ)`);
                         return;
                    }
                    showPage('play-page');
                    if(currentQuiz.category === 'worldcup') initWorldCup(data.questions);
                    else initNormalQuiz(data.questions);
                } else {
                    alert("ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
            } catch(e) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
        }

        // --- ì›”ë“œì»µ ë¡œì§ ---
        function initWorldCup(questions) {
            wcState.round = questions; 
            wcState.nextRound = [];
            wcState.roundName = questions.length; 
            nextWorldCupMatch();
        }

        function nextWorldCupMatch() {
            if(wcState.round.length === 0) {
                if(wcState.nextRound.length === 1) {
                    finishGame(wcState.nextRound[0], true); 
                    return;
                }
                wcState.round = wcState.nextRound;
                wcState.nextRound = [];
                wcState.roundName = wcState.round.length;
            }
            const left = wcState.round.pop();
            const right = wcState.round.pop();
            wcState.currentMatch = [left, right]; 
            renderWorldCupMatch(left, right);
        }

        function renderWorldCupMatch(left, right) {
            let roundTitle = wcState.roundName === 2 ? "ê²°ìŠ¹ì „" : `${wcState.roundName}ê°•`;
            document.getElementById('round-info').innerText = roundTitle;
            const con = document.getElementById('quiz-content');
            
            const imgL = left.image_url ? `${API_URL}${left.image_url}` : 'https://via.placeholder.com/300?text=No+Image';
            const imgR = right.image_url ? `${API_URL}${right.image_url}` : 'https://via.placeholder.com/300?text=No+Image';
            
            con.innerHTML = `
                <div class="wc-container">
                    <div class="wc-item" onclick="selectWinner(0)">
                        <img src="${imgL}"><div class="wc-text">${left.content}</div>
                    </div>
                    <div class="wc-vs">VS</div>
                    <div class="wc-item" onclick="selectWinner(1)">
                        <img src="${imgR}"><div class="wc-text">${right.content}</div>
                    </div>
                </div>
            `;
        }

        function selectWinner(idx) {
            wcState.nextRound.push(wcState.currentMatch[idx]);
            nextWorldCupMatch();
        }

        // --- ë§ˆì¶”ê¸°/ë°¸ëŸ°ìŠ¤ ë¡œì§ ---
        function initNormalQuiz(questions) {
            normalState.questions = questions;
            normalState.index = 0;
            normalState.scoreA = 0; 
            normalState.scoreB = 0; 
            normalState.score = 0;  
            renderNormalQuestion();
        }

        function renderNormalQuestion() {
            if(normalState.index >= normalState.questions.length) {
                finishGame(null, false);
                return;
            }
            const q = normalState.questions[normalState.index];
            document.getElementById('round-info').innerText = `${normalState.index + 1} / ${normalState.questions.length}`;
            const con = document.getElementById('quiz-content');
            
            if(currentQuiz.category === 'machugi') {
                const imgUrl = q.image_url ? `${API_URL}${q.image_url}` : 'https://via.placeholder.com/400x300?text=Guess+Who';
                
                let questionText = "ì´ ìºë¦­í„°/ì¸ë¬¼ì˜ ì´ë¦„ì€?";
                if(currentQuiz.id === 6) questionText = "ì´ êµ­ê¸°ëŠ” ì–´ëŠ ë‚˜ë¼ì¼ê¹Œìš”?"; 

                con.innerHTML = `
                    <img src="${imgUrl}" class="quiz-image">
                    <h2 class="quiz-question">${questionText}</h2>
                    <div class="machugi-input-container">
                        <input type="text" id="answerInput" class="machugi-input" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="off" onkeydown="if(event.key === 'Enter') checkMachugiAnswer()">
                        <button class="machugi-btn" onclick="checkMachugiAnswer()">ì œì¶œ</button>
                    </div>
                `;
                // ì¸í’‹ì— ìë™ í¬ì»¤ìŠ¤
                setTimeout(()=> document.getElementById('answerInput').focus(), 100);
            } 
            else if(currentQuiz.category === 'balance') {
                con.innerHTML = `<h2 class="quiz-question">${q.content}</h2>`;
                con.innerHTML += `
                    <div class="vs-container">
                        <div class="vs-item" onclick="nextNormal('A')"><h3>${q.choice_a}</h3></div>
                        <div class="vs-item" onclick="nextNormal('B')"><h3>${q.choice_b}</h3></div>
                    </div>`;
            } else { 
                if(q.image_url) con.innerHTML = `<img src="${API_URL}${q.image_url}" class="quiz-image">` + con.innerHTML;
                con.innerHTML += `<button class="btn btn-create" onclick="nextNormal()">ë‹¤ìŒ</button>`;
            }
        }

        function checkMachugiAnswer() {
            const input = document.getElementById('answerInput').value;
            if(!input.trim()) return alert("ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");

            const q = normalState.questions[normalState.index];
            const correct = q.content.replace(/\s+/g, '').toLowerCase(); 
            const user = input.replace(/\s+/g, '').toLowerCase();

            if(correct === user) {
                alert("ì •ë‹µì…ë‹ˆë‹¤! â­•");
                normalState.score++;
                normalState.index++;
                renderNormalQuestion();
            } else {
                alert(`í‹€ë ¸ìŠµë‹ˆë‹¤! âŒ (ì •ë‹µ: ${q.content})`);
                normalState.index++;
                renderNormalQuestion();
            }
        }

        function nextNormal(choice) { 
            if (choice === 'A') normalState.scoreA++;
            if (choice === 'B') normalState.scoreB++;
            normalState.index++; 
            renderNormalQuestion(); 
        }

        // --- ê²°ê³¼ ì²˜ë¦¬ ---
        function finishGame(winner, isWorldCup) {
            showPage('result-page');
            const wrapper = document.getElementById('result-content-wrapper');
            
            if(isWorldCup) {
                const img = winner.image_url ? `${API_URL}${winner.image_url}` : 'https://via.placeholder.com/300';
                wrapper.innerHTML = `
                    <div class="form-container simple-result-container">
                        <span class="result-icon" style="font-size: 50px;">ğŸ†</span>
                        <h2 class="page-title">ìš°ìŠ¹</h2>
                        <img src="${img}" class="simple-result-image">
                        <div class="simple-result-score">${winner.content}</div>
                        <button class="submit-btn" onclick="showPage('home')">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                    </div>
                `;
            } 
            else if (currentQuiz.category === 'machugi') {
                const total = normalState.questions.length;
                const correct = normalState.score;
                
                saveStats({ title: currentQuiz.title, correct: correct, total: total, ts: Date.now() });

                wrapper.innerHTML = `
                    <section class="panel">
                        <h1 class="page-title">ê²°ê³¼</h1>
                        <p class="subtitle">ì •ë‹µë¥ (%)ì— ë”°ë¼ ë“±ê¸‰ì„ ë¶€ì—¬í•©ë‹ˆë‹¤</p>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-title">ì •ë‹µ ìˆ˜</div>
                                <div class="stat-value" id="stat-correct">0</div>
                                <div class="subtitle" id="stat-total">ì „ì²´ 0ë¬¸ì œ</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-title">ì •ë‹µë¥ </div>
                                <div class="stat-value"><span id="stat-percent">0</span>%</div>
                                <div class="progress"><div id="stat-bar" class="progress-bar" style="width:0%"></div></div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-title">ë“±ê¸‰</div>
                                <div class="stat-value"><span id="stat-grade" class="grade-badge grade-F">F</span></div>
                                <div class="subtitle" id="stat-grade-text"></div>
                            </div>
                        </div>
                        <div class="recent">
                            <div class="recent-head"><div>ì¼ì‹œ</div><div>í€´ì¦ˆ ì œëª©</div><div>ê²°ê³¼</div><div>ì •ë‹µë¥ </div></div>
                            <div id="recent-container"></div>
                            <div class="recent-actions">
                                <button class="btn btn-outline" onclick="clearStats()">ê¸°ë¡ ì´ˆê¸°í™”</button>
                            </div>
                        </div>
                        <button class="submit-btn" style="margin-top:20px;" onclick="showPage('home')">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                    </section>
                `;
                renderStats();
            } 
            else if (currentQuiz.category === 'balance') {
                wrapper.innerHTML = `
                    <div class="form-container simple-result-container">
                        <span class="result-icon" style="font-size: 50px;">âš–ï¸</span>
                        <h2 class="page-title">ê²Œì„ ì¢…ë£Œ</h2>
                        <div class="simple-result-desc">
                            ëª¨ë“  ë¬¸ì œë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.
                        </div>
                        <button class="submit-btn" onclick="showPage('home')">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                    </div>
                `;
            } else {
                wrapper.innerHTML = `<div class="form-container"><h2 class="page-title">ì™„ë£Œ</h2><button class="submit-btn" onclick="showPage('home')">í™ˆìœ¼ë¡œ</button></div>`;
            }
        }

        // ê³µí†µ í˜ì´ì§€ ì „í™˜ ë° Auth
        function showPage(id) {
            const pages = ['home-page','create-page','login-page','play-page','result-page','select-count-page'];
            pages.forEach(p => {
                const el = document.getElementById(p);
                if(el) el.classList.add('hidden');
            });
            const targetId = id.endsWith('-page') ? id : id + '-page';
            const targetEl = document.getElementById(targetId);
            if(targetEl) targetEl.classList.remove('hidden');
            if (id === 'create') addQuestionCard();
        }

        async function checkLogin() {
            try {
                const res = await fetch(`${API_URL}/api/check-login`,{credentials:'include'});
                const d = await res.json();
                updateAuthUI(d.loggedIn);
            } catch(e){}
        }

        function updateAuthUI(isLoggedIn) {
            if(isLoggedIn) {
                document.getElementById('auth-guest').classList.add('hidden');
                document.getElementById('auth-user').classList.remove('hidden');
            } else {
                document.getElementById('auth-guest').classList.remove('hidden');
                document.getElementById('auth-user').classList.add('hidden');
            }
        }

        function goToLogin(signup){
            showPage('login');
            isSignupMode = signup;
            toggleAuthMode();
        }
        
        function toggleAuthMode() {
            const t = document.getElementById('auth-title');
            const btn = document.getElementById('auth-btn');
            ['auth-username','auth-email','auth-password','auth-nickname','auth-password-confirm'].forEach(id=>document.getElementById(id).value='');
            if(isSignupMode) {
                t.innerText = 'íšŒì›ê°€ì…'; btn.innerText = 'ê°€ì…í•˜ê¸°';
                document.getElementById('email-group').classList.remove('hidden');
                document.getElementById('nickname-group').classList.remove('hidden');
                document.getElementById('password-confirm-group').classList.remove('hidden');
                document.getElementById('btn-check-id').classList.remove('hidden');
            } else {
                t.innerText = 'ë¡œê·¸ì¸'; btn.innerText = 'ë¡œê·¸ì¸ í•˜ê¸°';
                document.getElementById('email-group').classList.add('hidden');
                document.getElementById('nickname-group').classList.add('hidden');
                document.getElementById('password-confirm-group').classList.add('hidden');
                document.getElementById('btn-check-id').classList.add('hidden');
            }
        }
        function toggleFindMode() {
            const as=document.getElementById('auth-section'); const fs=document.getElementById('find-section'); const t=document.getElementById('auth-title');
            if(fs.classList.contains('hidden')){ as.classList.add('hidden'); fs.classList.remove('hidden'); t.innerText='ê³„ì • ì°¾ê¸°'; }
            else{ fs.classList.add('hidden'); as.classList.remove('hidden'); t.innerText=isSignupMode?'íšŒì›ê°€ì…':'ë¡œê·¸ì¸'; }
        }
        
        async function checkId(){ 
            const u=document.getElementById('auth-username').value; if(!u)return alert("ì•„ì´ë”” ì…ë ¥"); 
            try{const r=await fetch(`${API_URL}/api/check-username`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u})}); const d=await r.json(); alert(d.message);}catch(e){alert("ì˜¤ë¥˜");} 
        }
        async function handleFindAccount(){ 
            const e=document.getElementById('find-email').value; if(!e)return alert("ì´ë©”ì¼ ì…ë ¥"); 
            try{const r=await fetch(`${API_URL}/api/find-account`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:e})}); const d=await r.json(); if(d.success){alert(`ID:${d.username}\nPW:${d.password}`); toggleFindMode();}else alert(d.message);}catch(e){alert("ì˜¤ë¥˜");} 
        }

        async function handleAuth(){ 
            const u = document.getElementById('auth-username').value; 
            const p = document.getElementById('auth-password').value; 
            if(!u || !p) return alert("ì •ë³´ ì…ë ¥"); 
            if(isSignupMode) {
                const pConfirm = document.getElementById('auth-password-confirm').value;
                if(p !== pConfirm) return alert("ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜");
            }
            const url = isSignupMode ? `${API_URL}/api/signup` : `${API_URL}/api/login`; 
            const body = {username: u, password: p}; 
            if(isSignupMode){ body.email = document.getElementById('auth-email').value; body.nickname = document.getElementById('auth-nickname').value; }
            try{
                const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(body)}); 
                const d=await res.json(); 
                if(d.success){
                    if(isSignupMode){alert("ê°€ì… ì„±ê³µ"); isSignupMode=false; toggleAuthMode();}
                    else{alert("í™˜ì˜í•©ë‹ˆë‹¤"); updateAuthUI(true); showPage('home');}
                }else alert(d.message);
            }catch(e){alert("ì˜¤ë¥˜");} 
        }
        
        async function handleLogout(){ 
            try{await fetch(`${API_URL}/api/logout`,{method:'POST',credentials:'include'}); alert("ë¡œê·¸ì•„ì›ƒ"); updateAuthUI(false); showPage('home');}catch(e){} 
        }

        let activeCategory = 'all';
        function filterCategory(cat, el) { document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); el.classList.add('active'); activeCategory=cat; applyFilters(); }
        function applyFilters() { const k=document.getElementById('search-input').value.toLowerCase(); const f=allQuizzes.filter(q=>{ const c=activeCategory==='all'||q.category===activeCategory; const t=q.title.toLowerCase().includes(k); return c&&t; }); renderQuizzes(f); }
        document.getElementById('search-input').addEventListener('input', applyFilters);

        let qCount=0;
        function addQuestionCard(){ qCount++; document.getElementById("questionList").innerHTML += `<div class="qc-question-card"><div class="qc-question-upload">ì´ë¯¸ì§€</div><div class="qc-question-meta"><input type="text" class="form-input" placeholder="ì •ë‹µ"></div></div>`; }
    </script>
</body>
</html>